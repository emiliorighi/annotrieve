"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7130],{37130:function(e,t,r){r.r(t),r.d(t,{default:function(){return m}});var i=r(56831),n=r(77207),s=r(42382),a=r(47858),o=r(61795),h=r(52427),l=r(47368),f=r(47358),u=r(15097),c=r(60288),d=r(96764);class g{constructor(e,t,r){this.record=e,this.adapter=t,this.ref=r}id(){return`${this.adapter.id}-${this.record.id}`}get mismatches(){return(0,c.zl)(this.record.CIGAR,this.record.tags.MD,this.record.seq,this.ref,this.record.qual)}get qual(){var e;return null===(e=this.record.qual)||void 0===e?void 0:e.join(" ")}get(e){return"mismatches"===e?this.mismatches:"qual"===e?this.qual:this.fields[e]}parent(){}children(){}get fields(){let e=this.record,t=this.adapter,r=e.isPaired();return{start:e.start,name:e.name,end:e.end,score:e.score,strand:e.strand,template_length:e.template_length,flags:e.flags,tags:e.tags,refName:t.refIdToName(e.ref_id),CIGAR:e.CIGAR,seq:e.seq,type:"match",pair_orientation:e.pair_orientation,next_ref:r?t.refIdToName(e.next_refid):void 0,next_pos:r?e.next_pos:void 0,next_segment_position:r?`${t.refIdToName(e.next_refid)}:${e.next_pos+1}`:void 0,uniqueId:this.id()}}toJSON(){return{...this.fields,qual:this.qual}}}(0,d.Cv)(g,"fields"),(0,d.Cv)(g,"mismatches");class m extends n.BaseFeatureDataAdapter{constructor(){super(...arguments),this.ultraLongFeatureCache=new a.default({maxSize:500})}async configurePre(){let e=this.getConf("bamLocation"),t=this.getConf(["index","location"]),r=this.getConf(["index","indexType"]),n=this.pluginManager,s="CSI"===r,a=new i.$({bamFilehandle:(0,o.openLocation)(e,n),csiFilehandle:s?(0,o.openLocation)(t,n):void 0,baiFilehandle:s?void 0:(0,o.openLocation)(t,n),yieldThreadTime:Number.POSITIVE_INFINITY}),h=this.getConf("sequenceAdapter");if(h&&this.getSubAdapter){let{dataAdapter:e}=await this.getSubAdapter(h);return{bam:a,sequenceAdapter:e}}return{bam:a}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(e=>{throw this.configureP=void 0,e})),this.configureP}async getHeader(e){let{bam:t}=await this.configure();return t.getHeaderText()}async setupPre(e){let{bam:t}=await this.configure(),r=await t.getHeader(),i=[],n={};if(r)for(let[e,t]of r.filter(e=>"SQ"===e.tag).entries()){let r=t.data.find(e=>"SN"===e.tag);if(r){let t=r.value;n[t]=e,i[e]=t}}return this.samHeader={idToName:i,nameToId:n},this.samHeader}async setupPre2(e){return this.setupP||(this.setupP=this.setupPre(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async setup(e){let{statusCallback:t=()=>{}}=e||{};return(0,s.updateStatus)("Downloading index",t,()=>this.setupPre2(e))}async getRefNames(e){let{idToName:t}=await this.setup(e);return t}async seqFetch(e,t,r){let{sequenceAdapter:i}=await this.configure();if(!i||!e)return;let n=i.getFeatures({refName:e,start:t,end:r,assemblyName:""}),s=await (0,f.z)(n.pipe((0,u.q)())),a="";for(let e of s.sort((e,t)=>e.get("start")-t.get("start"))){let i=e.get("start"),n=e.get("end"),s=Math.max(t-i,0),o=Math.min(r-i,n-i)-s;a+=(e.get("seq")||e.get("residues")).slice(s,s+o)}if(a.length!==r-t)throw Error(`sequence fetch failed: fetching ${e}:${(t-1).toLocaleString()}-${r.toLocaleString()} returned ${a.length.toLocaleString()} bases, but should have returned ${(r-t).toLocaleString()}`);return a}getFeatures(e,t){let{refName:r,start:i,end:n,originalRefName:a}=e,{stopToken:o,filterBy:f,statusCallback:u=()=>{}}=t||{};return(0,h.ObservableCreate)(async e=>{let{bam:h}=await this.configure();await this.setup(t),(0,l.checkStopToken)(o);let c=await (0,s.updateStatus)("Downloading alignments",u,()=>h.getRecordsForRange(r,i,n));(0,l.checkStopToken)(o),await (0,s.updateStatus)("Processing alignments",u,async()=>{let{flagInclude:t=0,flagExclude:i=0,tagFilter:n,readName:s}=f||{};for(let o of c){let h;if(o.tags.MD||(h=await this.seqFetch(a||r,o.start,o.end)),(0,d.qy)(o.flags,t,i)||n&&(0,d.Gk)(o.tags[n.tag],n.value)||s&&o.name!==s)continue;let l=this.ultraLongFeatureCache.get(`${o.id}`);if(l)e.next(l);else{let t=new g(o,this,h);this.ultraLongFeatureCache.set(`${o.id}`,t),e.next(t)}}e.complete()})})}async getMultiRegionFeatureDensityStats(e,t){let{bam:r}=await this.configure();return r.index?{bytes:await (0,s.bytesForRegions)(e,r),fetchSizeLimit:this.getConf("fetchSizeLimit")}:super.getMultiRegionFeatureDensityStats(e,t)}refIdToName(e){var t;return null===(t=this.samHeader)||void 0===t?void 0:t.idToName[e]}}},56831:function(e,t,r){r.d(t,{$:function(){return T},S5:function(){return R}});var i,n=r(51936);class s{constructor(e,t,r,i){this.minv=e,this.maxv=t,this.bin=r,this._fetchedSize=i}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(e){return this.minv.compareTo(e.minv)||this.maxv.compareTo(e.maxv)||this.bin-e.bin}fetchedSize(){return void 0!==this._fetchedSize?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}class a{constructor({filehandle:e,renameRefSeq:t=e=>e}){this.filehandle=e,this.renameRefSeq=t}}function o(e,t){let r;let i=[];if(0===e.length)return e;for(let s of(e.sort((e,t)=>{let r=e.minv.blockPosition-t.minv.blockPosition;return 0===r?e.minv.dataPosition-t.minv.dataPosition:r}),e))if(!t||s.maxv.compareTo(t)>0){if(void 0===r)i.push(s),r=s;else{var n;(n=r,s.minv.blockPosition-n.maxv.blockPosition<65e3&&s.maxv.blockPosition-n.minv.blockPosition<5e6)?s.maxv.compareTo(r.maxv)>0&&(r.maxv=s.maxv):(i.push(s),r=s)}}return i}function h(e,t){return{lineCount:function(e,t=0){let r=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24;return((e[t+4]|e[t+5]<<8|e[t+6]<<16|e[t+7]<<24)>>>0)*4294967296+(r>>>0)}(e,t)}}function l(e,t){return e?e.compareTo(t)>0?t:e:t}async function f(e){let t=[];for await(let r of e)t=t.concat(r);return t}class u{constructor(e,t){this.blockPosition=e,this.dataPosition=t}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(e){return this.blockPosition-e.blockPosition||this.dataPosition-e.dataPosition}}function c(e,t=0,r=!1){if(r)throw Error("big-endian virtual file offsets not implemented");return new u(1099511627776*e[t+7]+4294967296*e[t+6]+16777216*e[t+5]+65536*e[t+4]+256*e[t+3]+e[t+2],e[t+1]<<8|e[t])}class d extends a{async lineCount(e,t){let r=await this.parse(t);return r.indices(e)?.stats?.lineCount||0}async _parse(e){let t;let r=await this.filehandle.readFile(),i=new DataView(r.buffer);if(21578050!==i.getUint32(0,!0))throw Error("Not a BAI file");let a=i.getInt32(4,!0),o=8,f=[];for(let e=0;e<a;e++){f.push(o);let e=i.getInt32(o,!0);o+=4;for(let t=0;t<e;t+=1){let e=i.getUint32(o,!0);if(o+=4,37450===e)o+=36;else if(e>37450)throw Error("bai index contains too many bins, please use CSI");else{let e=i.getInt32(o,!0);o+=4;for(let t=0;t<e;t++)o+=16}}let n=i.getInt32(o,!0);o+=4;let s=Array(n);for(let e=0;e<n;e++){let i=c(r,o);o+=8,t=l(t,i),s[e]=i}}let u=new n({maxSize:5});return{bai:!0,firstDataLine:t,maxBlockSize:65536,indices:e=>{if(!u.has(e)){let n=function(e){let n,a=f[e];if(void 0===a)return;let o=i.getInt32(a,!0);a+=4;let u={};for(let e=0;e<o;e+=1){let e=i.getUint32(a,!0);if(a+=4,37450===e)a+=4,n=h(r,a+16),a+=32;else if(e>37450)throw Error("bai index contains too many bins, please use CSI");else{let n=i.getInt32(a,!0);a+=4;let o=Array(n);for(let i=0;i<n;i++){let n=c(r,a),h=c(r,a+=8);a+=8,t=l(t,n),o[i]=new s(n,h,e)}u[e]=o}}let d=i.getInt32(a,!0);a+=4;let g=Array(d);for(let e=0;e<d;e++){let i=c(r,a);a+=8,t=l(t,i),g[e]=i}return{binIndex:u,linearIndex:g,stats:n}}(e);return n&&u.set(e,n),n}return u.get(e)},refCount:a}}async indexCov(e,t,r,i){let n=(await this.parse(i)).indices(e);if(!n)return[];let{linearIndex:s=[],stats:a}=n;if(0===s.length)return[];let o=void 0===r?(s.length-1)*16384:r-r%16384+16384,h=void 0===t?0:t-t%16384,l=void 0!==t?Array((o-h)/16384):Array(s.length-1),f=s[s.length-1].blockPosition;if(o>(s.length-1)*16384)throw Error("query outside of range of linear index");let u=s[h/16384].blockPosition;for(let e=h/16384,t=0;e<o/16384;e++,t++)l[t]={score:s[e+1].blockPosition-u,start:16384*e,end:16384*e+16384},u=s[e+1].blockPosition;return l.map(e=>({...e,score:e.score*(a?.lineCount||0)/f}))}async blocksForRange(e,t,r,i={}){var n,a;let h;t<0&&(t=0);let l=await this.parse(i);if(!l)return[];let f=l.indices(e);if(!f)return[];let u=[[0,0],[1+((n=t)>>26),1+((a=r-1)>>26)],[9+(n>>23),9+(a>>23)],[73+(n>>20),73+(a>>20)],[585+(n>>17),585+(a>>17)],[4681+(n>>14),4681+(a>>14)]],c=[];for(let[e,t]of u)for(let r=e;r<=t;r++)if(f.binIndex[r])for(let e of f.binIndex[r])c.push(new s(e.minv,e.maxv,r));let d=f.linearIndex.length,g=Math.min(t>>14,d-1),m=Math.min(r>>14,d-1);for(let e=g;e<=m;++e){let t=f.linearIndex[e];t&&(!h||0>t.compareTo(h))&&(h=t)}return o(c,h)}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(e,t={}){let r=await this.parse(t);return!!r.indices(e)?.binIndex}}var g=r(37519),m=r(89326),p=r(3549),w=r(9762);function b(e,t){return Math.floor(e/2**t)}class y extends a{constructor(){super(...arguments),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(e,t){let r=await this.parse(t);return r.indices(e)?.stats?.lineCount||0}async indexCov(){return[]}parseAuxData(e,t){let r=new DataView(e.buffer),i=r.getUint32(t,!0),n={0:"generic",1:"SAM",2:"VCF"}[15&i];if(!n)throw Error(`invalid Tabix preset format flags ${i}`);let s={ref:r.getInt32(t+4,!0),start:r.getInt32(t+8,!0),end:r.getInt32(t+12,!0)},a=r.getInt32(t+16,!0),o=a?String.fromCharCode(a):"",h=r.getInt32(t+20,!0),l=r.getInt32(t+24,!0);return{columnNumbers:s,coordinateType:65536&i?"zero-based-half-open":"1-based-closed",metaValue:a,metaChar:o,skipLines:h,format:n,formatFlags:i,...function(e,t=e=>e){let r=0,i=0,n=[],s={};for(let a=0;a<e.length;a+=1)if(!e[a]){if(i<a){let o="";for(let t=i;t<a;t++)o+=String.fromCharCode(e[t]);o=t(o),n[r]=o,s[o]=r}i=a+1,r+=1}return{refNameToId:s,refIdToName:n}}(e.subarray(t+28,t+28+l),this.renameRefSeq)}}async _parse(e){let t,r;let i=await this.filehandle.readFile(e),a=await (0,g.Ri)(i),o=new DataView(a.buffer),f=o.getUint32(0,!0);if(21582659===f)t=1;else if(38359875===f)t=2;else throw Error(`Not a CSI file ${f}`);this.minShift=o.getInt32(4,!0),this.depth=o.getInt32(8,!0),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;let u=this.maxBinNumber,d=o.getInt32(12,!0),m=d>=30?this.parseAuxData(a,16):void 0,p=o.getInt32(16+d,!0),w=16+d+4,b=[];for(let e=0;e<p;e++){b.push(w);let e=o.getInt32(w,!0);w+=4;for(let t=0;t<e;t++){let e=o.getUint32(w,!0);if(w+=4,e>this.maxBinNumber)w+=44;else{w+=8;let e=o.getInt32(w,!0);w+=4;for(let t=0;t<e;t+=1){let e=c(a,w);w+=16,r=l(r,e)}}}}let y=new n({maxSize:5});return{csiVersion:t,firstDataLine:r,indices:e=>{if(!y.has(e)){let t=function(e){let t,i=b[e];if(void 0===i)return;let n=o.getInt32(i,!0);i+=4;let f={};for(let e=0;e<n;e++){let e=o.getUint32(i,!0);if(i+=4,e>u)t=h(a,i+28),i+=44;else{r=l(r,c(a,i)),i+=8;let t=o.getInt32(i,!0);i+=4;let n=Array(t);for(let r=0;r<t;r+=1){let t=c(a,i),o=c(a,i+=8);i+=8,n[r]=new s(t,o,e)}f[e]=n}}return{binIndex:f,stats:t}}(e);return t&&y.set(e,t),t}return y.get(e)},refCount:p,csi:!0,maxBlockSize:65536,...m}}async blocksForRange(e,t,r,i={}){t<0&&(t=0);let n=(await this.parse(i)).indices(e);if(!n)return[];let s=this.reg2bins(t,r);if(0===s.length)return[];let a=[];for(let[e,t]of s)for(let r=e;r<=t;r++)if(n.binIndex[r])for(let e of n.binIndex[r])a.push(e);return o(a,new u(0,0))}reg2bins(e,t){(e-=1)<1&&(e=1),t>0x4000000000000&&(t=17179869184),t-=1;let r=0,i=0,n=this.minShift+3*this.depth,s=[];for(;r<=this.depth;n-=3,i+=1*2**(3*r),r+=1){let r=i+b(e,n),a=i+b(t,n);if(a-r+s.length>this.maxBinNumber)throw Error(`query ${e}-${t} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);s.push([r,a])}return s}async parse(e={}){return this.setupP||(this.setupP=this._parse(e).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(e,t={}){let r=await this.parse(t);return!!r.indices(e)?.binIndex}}class x{read(){throw Error("never called")}stat(){throw Error("never called")}readFile(){throw Error("never called")}close(){throw Error("never called")}}var _=function(e,t,r,i,n){if("m"===i)throw TypeError("Private method is not writable");if("a"===i&&!n)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?n.call(e,r):n?n.value=r:t.set(e,r),r},v=function(e,t,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)};let I="=ACMGRSVTWYHKDBN".split(""),P="MIDNSHP=X???????".split("");class S{constructor(e){i.set(this,void 0),this.bytes=e.bytes,this.fileOffset=e.fileOffset,_(this,i,new DataView(this.bytes.byteArray.buffer),"f")}get byteArray(){return this.bytes.byteArray}get flags(){return(4294901760&v(this,i,"f").getInt32(this.bytes.start+16,!0))>>16}get ref_id(){return v(this,i,"f").getInt32(this.bytes.start+4,!0)}get start(){return v(this,i,"f").getInt32(this.bytes.start+8,!0)}get end(){return this.start+this.length_on_ref}get id(){return this.fileOffset}get mq(){let e=(65280&this.bin_mq_nl)>>8;return 255===e?void 0:e}get score(){return this.mq}get qual(){if(this.isSegmentUnmapped())return;let e=this.b0+this.read_name_length+4*this.num_cigar_ops+this.num_seq_bytes;return this.byteArray.subarray(e,e+this.seq_length)}get strand(){return this.isReverseComplemented()?-1:1}get b0(){return this.bytes.start+36}get name(){let e="";for(let t=0;t<this.read_name_length-1;t++)e+=String.fromCharCode(this.byteArray[this.b0+t]);return e}get tags(){let e=this.b0+this.read_name_length+4*this.num_cigar_ops+this.num_seq_bytes+this.seq_length,t=this.bytes.end,r={};for(;e<t;){let n=String.fromCharCode(this.byteArray[e],this.byteArray[e+1]),s=String.fromCharCode(this.byteArray[e+2]);if(e+=3,"A"===s)r[n]=String.fromCharCode(this.byteArray[e]),e+=1;else if("i"===s)r[n]=v(this,i,"f").getInt32(e,!0),e+=4;else if("I"===s)r[n]=v(this,i,"f").getUint32(e,!0),e+=4;else if("c"===s)r[n]=v(this,i,"f").getInt8(e),e+=1;else if("C"===s)r[n]=v(this,i,"f").getUint8(e),e+=1;else if("s"===s)r[n]=v(this,i,"f").getInt16(e,!0),e+=2;else if("S"===s)r[n]=v(this,i,"f").getUint16(e,!0),e+=2;else if("f"===s)r[n]=v(this,i,"f").getFloat32(e,!0),e+=4;else if("Z"===s||"H"===s){let i=[];for(;e<=t;){let t=this.byteArray[e++];if(0!==t)i.push(String.fromCharCode(t));else break}r[n]=i.join("")}else if("B"===s){let t=String.fromCharCode(this.byteArray[e++]),s=v(this,i,"f").getInt32(e,!0);if(e+=4,"i"===t){if("CG"===n){let t=[];for(let r=0;r<s;r++){let r=v(this,i,"f").getInt32(e,!0),n=r>>4,s=P[15&r];t.push(n+s),e+=4}r[n]=t.join("")}else{let t=[];for(let r=0;r<s;r++)t.push(v(this,i,"f").getInt32(e,!0)),e+=4;r[n]=t}}else if("I"===t){if("CG"===n){let t=[];for(let r=0;r<s;r++){let r=v(this,i,"f").getUint32(e,!0),n=r>>4,s=P[15&r];t.push(n+s),e+=4}r[n]=t.join("")}else{let t=[];for(let r=0;r<s;r++)t.push(v(this,i,"f").getUint32(e,!0)),e+=4;r[n]=t}}else if("s"===t){let t=[];for(let r=0;r<s;r++)t.push(v(this,i,"f").getInt16(e,!0)),e+=2;r[n]=t}else if("S"===t){let t=[];for(let r=0;r<s;r++)t.push(v(this,i,"f").getUint16(e,!0)),e+=2;r[n]=t}else if("c"===t){let t=[];for(let r=0;r<s;r++)t.push(v(this,i,"f").getInt8(e)),e+=1;r[n]=t}else if("C"===t){let t=[];for(let r=0;r<s;r++)t.push(v(this,i,"f").getUint8(e)),e+=1;r[n]=t}else if("f"===t){let t=[];for(let r=0;r<s;r++)t.push(v(this,i,"f").getFloat32(e,!0)),e+=4;r[n]=t}}else{console.error("Unknown BAM tag type",s);break}}return r}isPaired(){return!!(1&this.flags)}isProperlyPaired(){return!!(2&this.flags)}isSegmentUnmapped(){return!!(4&this.flags)}isMateUnmapped(){return!!(8&this.flags)}isReverseComplemented(){return!!(16&this.flags)}isMateReverseComplemented(){return!!(32&this.flags)}isRead1(){return!!(64&this.flags)}isRead2(){return!!(128&this.flags)}isSecondary(){return!!(256&this.flags)}isFailedQc(){return!!(512&this.flags)}isDuplicate(){return!!(1024&this.flags)}isSupplementary(){return!!(2048&this.flags)}get cigarAndLength(){if(this.isSegmentUnmapped())return{length_on_ref:0,CIGAR:""};let e=this.num_cigar_ops,t=this.b0+this.read_name_length,r=[],n=v(this,i,"f").getInt32(t,!0),s=n>>4,a=P[15&n];if("S"===a&&s===this.seq_length)return t+=4,s=(n=v(this,i,"f").getInt32(t,!0))>>4,"N"!==(a=P[15&n])&&console.warn("CG tag with no N tag"),{CIGAR:this.tags.CG,length_on_ref:s};{let o=0;for(let h=0;h<e;++h)s=(n=v(this,i,"f").getInt32(t,!0))>>4,a=P[15&n],r.push(s+a),"H"!==a&&"S"!==a&&"I"!==a&&(o+=s),t+=4;return{CIGAR:r.join(""),length_on_ref:o}}}get length_on_ref(){return this.cigarAndLength.length_on_ref}get CIGAR(){return this.cigarAndLength.CIGAR}get num_cigar_ops(){return 65535&this.flag_nc}get read_name_length(){return 255&this.bin_mq_nl}get num_seq_bytes(){return this.seq_length+1>>1}get seq(){let e=this.b0+this.read_name_length+4*this.num_cigar_ops,t=this.num_seq_bytes,r=this.seq_length,i=[],n=0;for(let s=0;s<t;++s){let t=this.byteArray[e+s];i.push(I[(240&t)>>4]),++n<r&&(i.push(I[15&t]),n++)}return i.join("")}get pair_orientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this.ref_id===this.next_refid){let e=this.isReverseComplemented()?"R":"F",t=this.isMateReverseComplemented()?"R":"F",r=" ",i=" ";this.isRead1()?(r="1",i="2"):this.isRead2()&&(r="2",i="1");let n=[];return this.template_length>0?(n[0]=e,n[1]=r,n[2]=t,n[3]=i):(n[2]=e,n[3]=r,n[0]=t,n[1]=i),n.join("")}}get bin_mq_nl(){return v(this,i,"f").getInt32(this.bytes.start+12,!0)}get flag_nc(){return v(this,i,"f").getInt32(this.bytes.start+16,!0)}get seq_length(){return v(this,i,"f").getInt32(this.bytes.start+20,!0)}get next_refid(){return v(this,i,"f").getInt32(this.bytes.start+24,!0)}get next_pos(){return v(this,i,"f").getInt32(this.bytes.start+28,!0)}get template_length(){return v(this,i,"f").getInt32(this.bytes.start+32,!0)}toJSON(){let e={};for(let t of Object.keys(this))t.startsWith("_")||"bytes"===t||(e[t]=this[t]);return e}}function k(e,t){let r=Object.getOwnPropertyDescriptor(e.prototype,t);if(!r)throw Error("OH NO, NO PROPERTY DESCRIPTOR");let i=r.get;if(!i)throw Error("OH NO, NOT A GETTER");Object.defineProperty(e.prototype,t,{get(){let e=i.call(this);return Object.defineProperty(this,t,{value:e}),e}})}function C(e){let t=e.split(/\r?\n/),r=[];for(let e of t){let[t,...i]=e.split(/\t/);t&&r.push({tag:t.slice(1),data:i.map(e=>{let t=e.indexOf(":");return{tag:e.slice(0,t),value:e.slice(t+1)}})})}return r}i=new WeakMap,k(S,"tags"),k(S,"cigarAndLength"),k(S,"seq"),k(S,"qual");class T{constructor({bamFilehandle:e,bamPath:t,bamUrl:r,baiPath:i,baiFilehandle:n,baiUrl:s,csiPath:a,csiFilehandle:o,csiUrl:h,htsget:l,yieldThreadTime:f=100,renameRefSeqs:u=e=>e}){if(this.htsget=!1,this.renameRefSeq=u,e)this.bam=e;else if(t)this.bam=new p.S9(t);else if(r)this.bam=new w.Z(r);else if(l)this.htsget=!0,this.bam=new x;else throw Error("unable to initialize bam");if(o)this.index=new y({filehandle:o});else if(a)this.index=new y({filehandle:new p.S9(a)});else if(h)this.index=new y({filehandle:new w.Z(h)});else if(n)this.index=new d({filehandle:n});else if(i)this.index=new d({filehandle:new p.S9(i)});else if(s)this.index=new d({filehandle:new w.Z(s)});else if(t)this.index=new d({filehandle:new p.S9(`${t}.bai`)});else if(r)this.index=new d({filehandle:new w.Z(`${r}.bai`)});else if(l)this.htsget=!0;else throw Error("unable to infer index format");this.yieldThreadTime=f}async getHeaderPre(e){let t;let r=function(e={}){return"aborted"in e?{signal:e}:e}(e);if(!this.index)return;let i=await this.index.parse(r),n=i.firstDataLine?i.firstDataLine.blockPosition+65535:void 0;t=n?await this.bam.read(n+65536,0):await this.bam.readFile(r);let s=await (0,g.Ri)(t),a=new DataView(s.buffer);if(21840194!==a.getInt32(0,!0))throw Error("Not a BAM file");let o=a.getInt32(4,!0),h=new TextDecoder("utf8");this.header=h.decode(s.subarray(8,8+o));let{chrToIndex:l,indexToChr:f}=await this._readRefSeqs(o+8,65535,r);return this.chrToIndex=l,this.indexToChr=f,C(this.header)}getHeader(e){return this.headerP||(this.headerP=this.getHeaderPre(e).catch(e=>{throw this.headerP=void 0,e})),this.headerP}async getHeaderText(e={}){return await this.getHeader(e),this.header}async _readRefSeqs(e,t,r){if(e>t)return this._readRefSeqs(e,2*t,r);let i=await this.bam.read(t,0,r),n=await (0,g.Ri)(i),s=new DataView(n.buffer),a=s.getInt32(e,!0),o=e+4,h={},l=[],f=new TextDecoder("utf8");for(let i=0;i<a;i+=1){let a=s.getInt32(o,!0),u=this.renameRefSeq(f.decode(n.subarray(o+4,o+4+a-1))),c=s.getInt32(o+a+4,!0);if(h[u]=i,l.push({refName:u,length:c}),(o=o+8+a)>n.length)return console.warn(`BAM header is very big.  Re-fetching ${t} bytes.`),this._readRefSeqs(e,2*t,r)}return{chrToIndex:h,indexToChr:l}}async getRecordsForRange(e,t,r,i){return f(this.streamRecordsForRange(e,t,r,i))}async *streamRecordsForRange(e,t,r,i){await this.getHeader(i);let n=this.chrToIndex?.[e];if(void 0!==n&&this.index){let e=await this.index.blocksForRange(n,t-1,r,i);yield*this._fetchChunkFeatures(e,n,t,r,i)}else yield[]}async *_fetchChunkFeatures(e,t,r,i,n={}){let{viewAsPairs:s}=n,a=[],o=!1;for(let s of e){let{data:e,cpositions:h,dpositions:l}=await this._readChunk({chunk:s,opts:n}),f=await this.readBamFeatures(e,h,l,s),u=[];for(let e of f)if(e.ref_id===t){if(e.start>=i){o=!0;break}e.end>=r&&u.push(e)}if(a.push(u),yield u,o)break}!function(e){if(e&&e.aborted){if("undefined"==typeof DOMException){let e=Error("aborted");throw e.code="ERR_ABORTED",e}throw new DOMException("aborted","AbortError")}}(n.signal),s&&(yield this.fetchPairs(t,a,n))}async fetchPairs(e,t,r){let{pairAcrossChr:i,maxInsertSize:n=2e5}=r,s={},a={};t.map(e=>{let t={};for(let r of e){let e=r.name,i=r.id;t[e]||(t[e]=0),t[e]++,a[i]=1}for(let[e,r]of Object.entries(t))1===r&&(s[e]=!0)});let o=[];t.map(t=>{for(let a of t){let t=a.name,h=a.start,l=a.next_pos,f=a.next_refid;this.index&&s[t]&&(i||f===e&&Math.abs(h-l)<n)&&o.push(this.index.blocksForRange(f,l,l+1,r))}});let h=new Map;for(let e of(await Promise.all(o)).flat())h.has(e.toString())||h.set(e.toString(),e);return(await Promise.all([...h.values()].map(async e=>{let{data:t,cpositions:i,dpositions:n,chunk:o}=await this._readChunk({chunk:e,opts:r}),h=[];for(let e of(await this.readBamFeatures(t,i,n,o)))s[e.name]&&!a[e.id]&&h.push(e);return h}))).flat()}async _readChunk({chunk:e,opts:t}){let r=await this.bam.read(e.fetchedSize(),e.minv.blockPosition,t),{buffer:i,cpositions:n,dpositions:s}=await (0,g.y$)(r,e);return{data:i,cpositions:n,dpositions:s,chunk:e}}async readBamFeatures(e,t,r,i){let n=0,s=[],a=0,o=+Date.now(),h=new DataView(e.buffer);for(;n+4<e.length;){let l=h.getInt32(n,!0),f=n+4+l-1;if(r){for(;n+i.minv.dataPosition>=r[a++];);a--}if(f<e.length){let h=new S({bytes:{byteArray:e,start:n,end:f},fileOffset:t.length>0?256*t[a]+(n-r[a])+i.minv.dataPosition+1:(0,m.Z)(e.subarray(n,f))>>>0});s.push(h),this.yieldThreadTime&&+Date.now()-o>this.yieldThreadTime&&(await new Promise(e=>setTimeout(e,1)),o=+Date.now())}n=f+1}return s}async hasRefSeq(e){let t=this.chrToIndex?.[e];return void 0!==t&&this.index?.hasRefSeq(t)}async lineCount(e){let t=this.chrToIndex?.[e];return void 0!==t&&this.index?this.index.lineCount(t):0}async indexCov(e,t,r){if(!this.index)return[];await this.index.parse();let i=this.chrToIndex?.[e];return void 0===i?[]:this.index.indexCov(i,t,r)}async blocksForRange(e,t,r,i){if(!this.index)return[];await this.index.parse();let n=this.chrToIndex?.[e];return void 0===n?[]:this.index.blocksForRange(n,t,r,i)}}async function $(e,t){let r=await Promise.all(e.map(async e=>{let{url:r,headers:i}=e;if(r.startsWith("data:")){let e=await fetch(r);if(!e.ok)throw Error("failed to decode base64");return new Uint8Array(await e.arrayBuffer())}{let{referer:e,...n}=i,s=await fetch(r,{...t,headers:{...t?.headers,...n}});if(!s.ok)throw Error(`HTTP ${s.status} fetching ${r}: ${await s.text()}`);return new Uint8Array(await s.arrayBuffer())}}));return function(e){let t=new Uint8Array(function(e){let t=0;for(let r of e)t+=r.length;return t}(e)),r=0;for(let i of e)t.set(i,r),r+=i.length;return t}(await Promise.all(r.map(e=>(0,g.Ri)(e))))}class R extends T{constructor(e){super({htsget:!0}),this.baseUrl=e.baseUrl,this.trackId=e.trackId}async *streamRecordsForRange(e,t,r,i){let n=`${this.baseUrl}/${this.trackId}`,s=`${n}?referenceName=${e}&start=${t}&end=${r}&format=BAM`,a=this.chrToIndex?.[e];if(void 0===a)yield[];else{let n=await fetch(s,{...i});if(!n.ok)throw Error(`HTTP ${n.status} fetching ${s}: ${await n.text()}`);let o=await n.json(),h=await $(o.htsget.urls.slice(1),i);yield*this._fetchChunkFeatures([{buffer:h,_fetchedSize:void 0,bin:0,compareTo:()=>0,toUniqueString:()=>`${e}_${t}_${r}`,fetchedSize:()=>0,minv:{dataPosition:0,blockPosition:0,compareTo:()=>0},maxv:{dataPosition:Number.MAX_SAFE_INTEGER,blockPosition:0,compareTo:()=>0},toString:()=>`${e}_${t}_${r}`}],a,t,r,i)}}async _readChunk({chunk:e}){if(!e.buffer)throw Error("expected chunk.buffer in htsget");return{data:e.buffer,cpositions:[],dpositions:[],chunk:e}}async getHeader(e={}){let t=`${this.baseUrl}/${this.trackId}?referenceName=na&class=header`,r=await fetch(t,e);if(!r.ok)throw Error(`HTTP ${r.status} fetching ${t}: ${await r.text()}`);let i=await r.json(),n=await $(i.htsget.urls,e),s=new DataView(n.buffer);if(21840194!==s.getInt32(0,!0))throw Error("Not a BAM file");let a=s.getInt32(4,!0),o=C(new TextDecoder("utf8").decode(n.subarray(8,8+a))),h=[],l={};for(let[e,t]of o.filter(e=>"SQ"===e.tag).entries()){let r="",i=0;for(let e of t.data)"SN"===e.tag?r=e.value:"LN"===e.tag&&(i=+e.value);l[r]=e,h[e]={refName:r,length:i}}return this.chrToIndex=l,this.indexToChr=h,o}}},37519:function(e,t,r){function i(e,t=0){let r=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24;return((e[t+4]|e[t+5]<<8|e[t+6]<<16|e[t+7]<<24)>>>0)*4294967296+(r>>>0)}function n(e,t,r){let i=t[1],n=r?r[1]:1/0;return i<=e&&n>e?0:i<e?-1:1}r.d(t,{q5:function(){return u},Ri:function(){return l},y$:function(){return f}});class s{constructor({filehandle:e}){this.filehandle=e}_getIndex(){return this.index||(this.index=this._readIndex().catch(e=>{throw this.index=void 0,e})),this.index}async _readIndex(){let e=i(await this.filehandle.read(8,0));if(!e)return[[0,0]];let t=Array(e+1);t[0]=[0,0];let r=16*e;if(r>Number.MAX_SAFE_INTEGER)throw TypeError("integer overflow");let n=await this.filehandle.read(r,8);for(let r=0;r<e;r+=1){let e=i(n,16*r),s=i(n,16*r+8);t[r+1]=[e,s]}return t}async getLastBlock(){return(await this._getIndex()).at(-1)}async getRelevantBlocksForRead(e,t){let r=t+e;if(0===e)return[];let i=await this._getIndex(),s=[],a=0,o=i.length-1,h=Math.floor(i.length/2),l=n(t,i[h],i[h+1]);for(;0!==l;)l>0?o=h-1:l<0&&(a=h+1),l=n(t,i[h=Math.ceil((o-a)/2)+a],i[h+1]);s.push(i[h]);let f=h+1;for(;f<i.length&&(s.push(i[f]),!(i[f][1]>=r));f+=1);return s[s.length-1][1]<r&&s.push([]),s}}function a(e){let t=new Uint8Array(function(e){let t=0;for(let r of e)t+=r.length;return t}(e)),r=0;for(let i of e)t.set(i,r),r+=i.length;return t}let{Z_SYNC_FLUSH:o,Inflate:h}=r(63624);async function l(e){try{let t,r;let i=0,n=[];do{let s=e.subarray(i);if(r=new h,{strm:t}=r,r.push(s,o),r.err)throw Error(r.msg);i+=t.next_in,n.push(r.result)}while(t.avail_in);return a(n)}catch(e){if(/incorrect header check/.exec(`${e}`))throw Error("problem decompressing block: incorrect gzip header check");throw e}}async function f(e,t,r){try{let i;let{minv:n,maxv:s}=t,l=n.blockPosition,f=n.dataPosition,u=[],c=[],d=[],g=0,m=!1;do{let t,a;let p=e.subarray(l-n.blockPosition),w=function(e,t){let r=t.subarray(0,Math.min(32,t.length)),i=0,n=r.length;for(let e=0;e<n;e++)i=(i<<5)-i+r[e]&4294967295;return`${e}_${i}`}(l,p),b=r?.get(w);if(b)t=b.buffer,a=b.nextIn,m=!0;else{let e=new h;if({strm:i}=e,e.push(p,o),e.err)throw Error(e.msg);t=e.result,a=i.next_in,m=!1,r?.set(w,{buffer:t,nextIn:a})}u.push(t);let y=t.length;c.push(l),d.push(f),1===u.length&&n.dataPosition&&(u[0]=u[0].subarray(n.dataPosition),y=u[0].length);let x=l;if(l+=a,f+=y,x>=s.blockPosition){u[g]=u[g].subarray(0,s.blockPosition===n.blockPosition?s.dataPosition-n.dataPosition+1:s.dataPosition+1),c.push(l),d.push(f);break}g++}while(m?l<e.length+n.blockPosition:i.avail_in);return{buffer:a(u),cpositions:c,dpositions:d}}catch(e){if(/incorrect header check/.exec(`${e}`))throw Error("problem decompressing block: incorrect gzip header check");throw e}}class u{constructor({filehandle:e,gziFilehandle:t}){this.filehandle=e,this.gzi=new s({filehandle:t})}async _readAndUncompressBlock(e,t){let r=t;r||(r=(await this.filehandle.stat()).size);let i=r-e;return l(await this.filehandle.read(i,e))}async read(e,t){let r=await this.gzi.getRelevantBlocksForRead(e,t),i=[];for(let n=0;n<r.length-1;n+=1){let s=await this._readAndUncompressBlock(r[n][0],r[n+1][0]),[,a]=r[n],o=a>=t?0:t-a,h=Math.min(t+e,a+s.length)-a;o>=0&&o<s.length&&i.push(s.subarray(o,h))}return a(i)}}},89326:function(e,t){let r=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];"undefined"!=typeof Int32Array&&(r=new Int32Array(r)),t.Z=(e,t)=>{let i=0===t?0:-1^~~t;for(let t=0;t<e.length;t++)i=r[(i^e[t])&255]^i>>>8;return -1^i}},3549:function(e,t,r){r.d(t,{S9:function(){return i}});class i{readFile(){throw Error("unimplemented")}read(){throw Error("unimplemented")}close(){throw Error("unimplemented")}}},9762:function(e,t,r){function i(e){return("object"==typeof e&&null!==e&&"message"in e?e.message:`${e}`).replace(/\.$/,"")}r.d(t,{Z:function(){return n}});class n{constructor(e,t={}){this.baseOverrides={},this.url=e;let r=t.fetch||globalThis.fetch.bind(globalThis);t.overrides&&(this.baseOverrides=t.overrides),this.fetchImplementation=r}async fetch(e,t){let r;try{r=await this.fetchImplementation(e,t)}catch(n){if(`${n}`.includes("Failed to fetch")){console.warn(`generic-filehandle: refetching ${e} to attempt to work around chrome CORS header caching bug`);try{r=await this.fetchImplementation(e,{...t,cache:"reload"})}catch(t){throw Error(`${i(t)} fetching ${e}`,{cause:t})}}else throw Error(`${i(n)} fetching ${e}`,{cause:n})}return r}async read(e,t,r={}){let{headers:i={},signal:n,overrides:s={}}=r;e<1/0?i.range=`bytes=${t}-${t+e}`:e===1/0&&0!==t&&(i.range=`bytes=${t}-`);let a=await this.fetch(this.url,{...this.baseOverrides,...s,headers:{...i,...s.headers,...this.baseOverrides.headers},method:"GET",redirect:"follow",mode:"cors",signal:n});if(!a.ok)throw Error(`HTTP ${a.status} fetching ${this.url}`);if(200===a.status&&0===t||206===a.status){let t=await a.arrayBuffer(),r=a.headers.get("content-range"),i=/\/(\d+)$/.exec(r||"");return i?.[1]&&(this._stat={size:parseInt(i[1],10)}),new Uint8Array(t.slice(0,e))}if(200===a.status)throw Error(`${this.url} fetch returned status 200, expected 206`);throw Error(`HTTP ${a.status} fetching ${this.url}`)}async readFile(e={}){let t,r;"string"==typeof e?(t=e,r={}):(t=e.encoding,r=e,delete r.encoding);let{headers:i={},signal:n,overrides:s={}}=r,a=await this.fetch(this.url,{headers:i,method:"GET",redirect:"follow",mode:"cors",signal:n,...this.baseOverrides,...s});if(200!==a.status)throw Error(`HTTP ${a.status} fetching ${this.url}`);if("utf8"===t)return a.text();if(!t)return new Uint8Array(await a.arrayBuffer());throw Error(`unsupported encoding: ${t}`)}async stat(){if(!this._stat&&(await this.read(10,0),!this._stat))throw Error(`unable to determine size of file at ${this.url}`);return this._stat}async close(){}}}}]);