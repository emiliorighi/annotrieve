"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6608],{26608:function(e,t,n){n.r(t),n.d(t,{default:function(){return w}});var s=n(57437),i=n(2265),r=n(98833),l=n(93618),a=n(37926),o=n(7934),c=n(47198),d=n(42382),u=n(47368),p=n(63168),x=n(17725),h=n(77639),v=n(90658),j=n(31835),g=n(17764),m=n(91904);let f=(0,c.observer)(function({model:e,children:t,handleClose:n}){let[l,a]=(0,i.useState)(""),[o,c]=(0,i.useState)(),[f,b]=(0,i.useState)(!1),[y,C]=(0,i.useState)(""),[S,k]=(0,i.useState)(!1),[Z,w]=(0,d.useLocalStorage)("cluster-samplesPerPixel","1");return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(x.Z,{children:[t,(0,s.jsxs)("div",{style:{marginTop:50},children:[(0,s.jsx)(h.Z,{variant:"contained",onClick:()=>{k(!S)},children:S?"Hide advanced options":"Show advanced options"}),S?(0,s.jsxs)("div",{style:{marginTop:20},children:[(0,s.jsx)(v.Z,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),(0,s.jsx)(j.Z,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:Z,onChange:e=>{w(e.target.value)}})]}):null]}),(0,s.jsxs)("div",{children:[f?(0,s.jsxs)("div",{style:{padding:50},children:[(0,s.jsx)("span",{children:l||"Loading..."}),(0,s.jsx)(h.Z,{onClick:()=>{(0,u.stopStopToken)(y)},children:"Stop"})]}):null,o?(0,s.jsx)(r.ErrorMessage,{error:o}):null]})]}),(0,s.jsxs)(g.Z,{children:[(0,s.jsx)(h.Z,{variant:"contained",disabled:f,onClick:async()=>{try{c(void 0),a("Initializing"),b(!0);let t=(0,d.getContainingView)(e);if(!t.initialized)return;let{rpcManager:s}=(0,d.getSession)(e),{sourcesWithoutLayout:i,adapterConfig:r}=e;if(i){let n=(0,p.getRpcSessionId)(e),l=(0,u.createStopToken)();C(l);let o=await s.call(n,"MultiWiggleClusterScoreMatrix",{regions:t.dynamicBlocks.contentBlocks,sources:i,sessionId:n,adapterConfig:r,stopToken:l,bpPerPx:t.bpPerPx/+Z,statusCallback:e=>{a(e)}});e.setLayout(o.order.map(e=>{let t=i[e];if(!t)throw Error(`out of bounds at ${e}`);return t}))}n()}catch(t){!(0,d.isAbortException)(t)&&(0,m.isAlive)(e)&&(console.error(t),c(t))}finally{b(!1),a(""),C("")}},children:"Run clustering"}),(0,s.jsx)(h.Z,{variant:"contained",color:"secondary",onClick:()=>{n(),y&&(0,u.stopStopToken)(y)},children:"Cancel"})]})]})});var b=n(49211),y=n.n(b),C=n(12);let S=(0,n(3905).makeStyles)()(e=>({textAreaFont:{fontFamily:"Courier New"},mgap:{display:"flex",flexDirection:"column",gap:e.spacing(4)}})),k=(0,c.observer)(function({model:e,handleClose:t,children:n}){let{classes:c}=S(),[u,f]=(0,i.useState)(""),[b,k]=(0,i.useState)(),[Z,w]=(0,i.useState)(),[A,M]=(0,i.useState)(!1),[E,R]=(0,d.useLocalStorage)("cluster-showAdvanced",!1),[T,P]=(0,i.useState)("single"),[$,B]=(0,i.useState)("1");(0,i.useEffect)(()=>{(async()=>{try{w(void 0),k(void 0),M(!0);let{dynamicBlocks:t,bpPerPx:n}=(0,d.getContainingView)(e),{rpcManager:s}=(0,d.getSession)(e),{sourcesWithoutLayout:i,adapterConfig:r}=e,l=(0,p.getRpcSessionId)(e),a=await s.call(l,"MultiWiggleGetScoreMatrix",{regions:t.contentBlocks,sources:i,sessionId:l,adapterConfig:r,bpPerPx:n/+$});k(a)}catch(t){!(0,d.isAbortException)(t)&&(0,m.isAlive)(e)&&(console.error(t),w(t))}finally{M(!1)}})()},[e,$]);let L=b?`inputMatrix<-matrix(c(${Object.values(b).map(e=>e.join(",")).join(",\n")}
),nrow=${Object.values(b).length},byrow=TRUE)
rownames(inputMatrix)<-c(${Object.keys(b).map(e=>`'${e}'`).join(",")})
resultClusters<-hclust(dist(inputMatrix), method='${T}')
cat(resultClusters$order,sep='\\n')`:void 0,O=b?Object.entries(b).map(([e,t])=>[e,...t].join("	")).join("\n"):void 0;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(x.Z,{children:[n,(0,s.jsxs)("div",{style:{marginTop:50},children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"16px"},children:[(0,s.jsx)(h.Z,{variant:"contained",onClick:()=>{(0,C.saveAs)(new Blob([L||""],{type:"text/plain;charset=utf-8"}),"cluster.R")},children:"Download Rscript"})," ","or"," ",(0,s.jsx)(h.Z,{variant:"contained",onClick:()=>{y()(L||"")},children:"Copy Rscript to clipboard"})," ","or"," ",(0,s.jsx)(h.Z,{variant:"contained",onClick:()=>{(0,C.saveAs)(new Blob([O||""],{type:"text/plain;charset=utf-8"}),"scores.tsv")},children:"Download TSV"})]}),(0,s.jsx)("div",{children:(0,s.jsx)(h.Z,{variant:"contained",onClick:()=>{R(!E)},children:E?"Hide advanced options":"Show advanced options"})}),E?(0,s.jsxs)("div",{children:[(0,s.jsx)(v.Z,{variant:"h6",children:"Advanced options"}),(0,s.jsx)(l.Z,{children:Object.entries({single:"Single",complete:"Complete"}).map(([e,t])=>(0,s.jsx)(a.Z,{control:(0,s.jsx)(o.Z,{checked:T===e,onChange:()=>{P(e)}}),label:t},e))}),(0,s.jsxs)("div",{style:{marginTop:20},children:[(0,s.jsx)(v.Z,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),(0,s.jsx)(j.Z,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:$,onChange:e=>{B(e.target.value)}})]})]}):null,L?(0,s.jsx)("div",{}):A?(0,s.jsx)(r.LoadingEllipses,{variant:"h6",title:"Generating score matrix"}):Z?(0,s.jsx)(r.ErrorMessage,{error:Z}):null]}),(0,s.jsxs)("div",{children:[(0,s.jsx)(v.Z,{variant:"subtitle2",gutterBottom:!0,style:{marginTop:"16px"},children:"Clustering Results:"}),(0,s.jsx)(j.Z,{multiline:!0,fullWidth:!0,variant:"outlined",placeholder:"Paste results from Rscript here (sequence of numbers, one per line, specifying the new ordering)",rows:10,value:u,onChange:e=>{f(e.target.value)},slotProps:{input:{classes:{input:c.textAreaFont}}}})]})]})]}),(0,s.jsxs)(g.Z,{children:[(0,s.jsx)(h.Z,{variant:"contained",onClick:()=>{let{sourcesWithoutLayout:n}=e;if(n)try{e.setLayout(u.split("\n").map(e=>e.trim()).filter(e=>!!e).map(e=>+e).map(e=>{let t=n[e-1];if(!t)throw Error(`out of bounds at ${e}`);return t}))}catch(t){console.error(t),(0,d.getSession)(e).notifyError(`${t}`,t)}t()},children:"Apply clustering"}),(0,s.jsx)(h.Z,{variant:"contained",color:"secondary",onClick:()=>{t()},children:"Cancel"})]})]})});function Z({activeMode:e,setActiveMode:t}){return(0,s.jsx)("div",{children:(0,s.jsx)(l.Z,{children:Object.entries({auto:(0,s.jsx)("div",{children:"Run in-app clustering (slower, particularly for large numbers of samples, uses JS implementation of hclust)"}),manual:(0,s.jsx)("div",{children:"Download R script to run clustering (faster, uses R implementation of hclust)"})}).map(([n,i])=>(0,s.jsx)(a.Z,{control:(0,s.jsx)(o.Z,{checked:e===n,onChange:()=>{t(n)}}),label:i},n))})})}var w=(0,c.observer)(function({model:e,handleClose:t}){let[n,l]=(0,i.useState)("auto");return(0,s.jsx)(r.Dialog,{open:!0,title:"Cluster by score",maxWidth:"xl",onClose:(e,n)=>{"backdropClick"!==n&&t()},children:"auto"===n?(0,s.jsx)(f,{model:e,handleClose:t,children:(0,s.jsx)(Z,{activeMode:n,setActiveMode:l})}):(0,s.jsx)(k,{model:e,handleClose:t,children:(0,s.jsx)(Z,{activeMode:n,setActiveMode:l})})})})}}]);